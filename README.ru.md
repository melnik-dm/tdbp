# Trace DataBase Project (tdbp)

Утилита tdbp предназначена для организации прослеживаемости, или трассируемости,
между единицами конфигурации (ЕК). Под ЕК подразумеваются файлы, располагающиеся
в хранилищах СКВ (Git, SVN и тд), или их части.

## ТРЕБУЕМЫЕ ПАКЕТЫ

```
pip3 install pygit2

pip3 install colorama

pip3 install packaging
```

Совместимость с pygit2:

- Ubuntu 16: pygit2 1.1.0
- Ubuntu 20: pygit2 1.13.3
- Windows 10: pygit2 1.14.0

Пример установки более старой версии pygit2:

```
pip3 install pygit2=='1.1.0'
(https://github.com/libgit2/pygit2/issues/999)
```

Дополнительные пакеты могут быть указаны в модулях обработки внутренних меток

## ОСНОВНЫЕ ВОЗМОЖНОСТИ

Утилита позволяет управлять данными трассировки (добавление, удаление, сброс 
копирование, просмотр, обновление), собирать покрытие, осуществлять экспорт 
проекта в распространенные форматы. Данные трассировки (ДТ) хранятся в рамках
проектах базы данных трассировок.

Варианты хранения проекта:
- отдельное хранилище под проект ДТ (например, ТВУ и ТНУ хранятся отдельно от 
ДТ ТВУ-ТНУ);
- вместе с данными, от которых идет трассировка наверх (например, ДТ ТВУ-ТНУ 
хранятся вместе с ТНУ).

Примечание - При совместном хранении ЕК и ДТ каждый ЗИ, требующий изменения и 
ЕК, и ДТ, необходимо реализовывать минимум двумя редакциями: в первом меняется 
ЕК, во втором - ДТ. Это связано с тем, что проект ДТ для каждого хранилища 
содержит информацию о его редакции; если изменения ЕК и ДТ будут в одной 
редакции, то ее невозможно зафиксировать, так как изменение ДТ (для сохранения 
редакции) будет приводить к изменению редакции.

Примечение - Подготовку ДТ для ЕК, находящихся в статусе РВ, необходимо 
реализовывать в рамках черновика. При этом первой командой черновика должна 
быть команда установки редакции хранилища, в котором находятся ЕК. Редакция 
должна быть указана в формате HEAD~<N> (например, HEAD или HEAD~1). Такой 
формат позволит установить актуальную редакцию в случае доработки РВ или 
выполнения ее перебазирования. После того, как установлена БВ, лучше произвести 
установку редакции без использования HEAD-формата.

## ПОРЯДОК РАБОТЫ

Далее приведен порядок работы с утилитой. Перед началом использования необходимо 
добавить путь до утилиты в PATH. Затем необходимо создать и настроить проект 
tdbp, если  проект уже создан и настроен, то следует сразу переходить к шагу 6.

Порядок не подразумевает описание всех команд утилиты. Для просмотра описания
команд необходимо воспользоваться специальным параметром '--help'. Параметр 
может быть передан любой команде, включая ее подкоманды.

```
tdbp.py --help
tdbp.py repo --help
tdbp.py repo bounds --help
```

### ШАГ 1. Создание проекта

Для начала работы с проектом необходимо создать пустую директорию, где будет
располагаться проект, перейти в нее и вызвать специальную команду утилиты. 

```
tdbp.py init
```

### ШАГ 2. Добавление хранилищ

После создания проекта необходимо создать хранилища, данные в которых
будут выступать трассируемыми объектами.

```
tdbp.py repo new --provider git --desc 'mygit:sw' sw
tdbp.py repo new --provider git --desc 'mygit:docs' docs
tdbp.py repo new --provider git --desc 'mygit:srs' srs
```

Каждому хранилищу при создании автоматически назначается одноименное объединение. 
Каждому объединению устанавливается определенный уровень. Уровень объединения 
отражает уровень декомпозиции ЕК, размещенных в хранилищах объединения: чем 
меньше уровень, тем более абстрактный уровень декомпозиции. Например, если 
рассматривать такие артефакты как ТВУ и ТНУ, то уровень объединения, который 
включает хранилища с ТВУ, должен быть меньше, чем уровень хранилища, который 
включает ТНУ: ТВУ - 1, ТНУ - 2. 

Первому созданному в рамках проекта объединению автоматически назначается 
уровень 1, каждому следующему назначается уровень на единицу выше, чем самый 
большой на момент его создания. Уровень может быть изменен в любой момент 
соответствующей командой. Новый назначаемый уровень, как и уровень, присваемый 
при создании, должен быть уникальным.

```
tdbp.py union --level 5 sw
```

Объединение также может быть создано вручную. В такие объединения, в отличии от
создаваемых вместе с хранилищами, можно добавлять несколько хранилищ.

```
tdbp.py union --new hlr
tdbp.py repo union --set hlr srs
```

### ШАГ 3. Установка границ для редакций

Каждому хранилищу назначается редакция, из которой берутся файлы для
их трассирования. Для назначаемых редакций могут быть установлены ограничения, 
или границы. Границы задают ветви, в которых должны присутствовать назначаемые 
редакции.

```
tdbp.py repo bounds --add origin/develop sw
```

### ШАГ 4. Настройка обработчиков внутренних меток

Файлы хранилищ могут быть представлены как единым целым, так и частями. К 
каждому расширению файла может быть привязан соответствующий обработчик, который
будет извлекать из файлов с этим расширением внутренние метки. Каждая внутренняя
метка файла может быть отдельно протрассирована, также как и трассируется файл
целиком, без привязанного к его расширению обработчика. Данный подход может
быть использован для трассирования конкретных функций, объявленных в h-файлах,
или для трассирования требований, которые представлены в pdf-файле.

```
tdbp.py repo label --add .pdf --handler label_bypass.py docs
```

### ШАГ 5. Установка фильтров

Некоторые функции утилиты (например, сбор статистики и экспорт) используют
информацию не только о фактически протрассированных файлах, но и о файлах, 
которые могут быть протрассированы в принципе. Так как в хранилище хранятся 
разные файлы, предусмотрен функционал их фильтрации. С помощью файлов .repoallow 
и .repodeny, располагающихся в <проект tdbp>/<хранилище>/.tdbp, можно задать
фильтры в формате fnmatch. 

### ШАГ 6. Привязка реального хранилища

На каждом рабочем месте необходимо привязать хранилища проекта к их физическому
расположению на диске.

```
tdbp.py repo ref --path ~/Development/workspace/sw/ sw
tdbp.py repo ref --path ~/Development/workspace/docs/ docs
```

### ШАГ 7. Установка редакции

Каждому хранилищу должна быть назначена редакция, из которой берутся файлы для
их трассирования.

```
tdbp.py repo rev --set HEAD sw
```

Задаваемые редакции будут проверяться на попадание установленные ранее границы 
(применимо для всех команд repo rev). Также уже установленная редакция может
быть проверена на попадание в границы.

```
tdbp.py repo rev --check sw
```

### ШАГ 8. Управление связями

Управление связями осуществляется для файлов и подфайлов, расположенных в 
рамках добавленных на этапе настройки проекта хранилищ. Файл идентифицируется
следующим образом: "repo/name##label@revision", где
repo - имя одного из хранилищ проекта;
name - путь до файла в рамках хранилища repo;
label - необязательная внутренняя метка файла name;
revision - необязательная редакция файла name (при составлении связей редакция 
не учитывается).

```
tdbp.py link --add sw/main.c docs/common/doc.pdf#PART-100
```

### ШАГ 9. Обновление связей

Обновление связей выполняется в следующих случаях:

- внесение изменений в ЕК в рамках ЗИ, а значит и обновление ДТ для этой ЕК, 
в частности сохранение старых связей для новой редакции ЕК (плавающая редакция, 
так как возможен rebase);
- переход на обновленную версию ЕК более высокого уровня без внесения изменений 
в ЕК низкого уровня (фиксированная редакция);
- исправление ошибки в ДТ (редакция не требует изменений).

Исправление ошибки детально рассматриваться не будет, так как подразумевается,
что ошибка устраняется в пределах 1-2 команд типа link (см. шаг 8). Остальные
варианты являются частными случаями первых двух. 

Примечание - В процессе обновления может потребоваться обновление редакции 
хранилища (см. шаг 7).

Если в ЕК были внесены изменения путем создания новой редакции хранилища, а 
хранилище в проекте ДТ указывает на старую редакцию, то необходимо выполнить
обновление связей. Обновление лучше всего выполнять через режим черновика, 
который позволяет подготовить и проверить набор команд перед их применением
на проекте ДТ.

Примечание - Важно помнить, что если ДТ обновляются в следствии изменения
редакции хранилища, то и в проекте ДТ редакция должна быть изменена (см. шаг 7).
Также важно учитывать возможность выполнения перебазирования (rebase), что 
может приводить к необходимости выполнения изменения редакции несколько раз 
(после каждого rebase).

### ШАГ 10. Работа с черновиком

Черновик представляет собой текстовый файл, который содержит на каждой строке
одну команду. Область применения черновика не ограничена. Далее будет рассмотрен
частный случай применения черновика при обновлении связей (см. шаг 9).

Перед тем как начинать заполнять черновик следует воспользоваться механизмом
просмотра отличий между текушей редакцией хранилища и заданной. Это позволит
понять, над какими связями следует производить изменения. Отличия могут быть
представлены в виде первоначального варианта черновика.

```
tdbp.py repo diff --rev HEAD --as-draft sw > draftfile
```

При добавлении команды в черновик она автоматически предварительно выполняется в 
песочнице (включая все проверки корректности команды и ее параметров).

```
tdbp.py drafting --draft draftfile "link --reset sw/.gitignore"
```

Черновик может быть применен в песочнице, чтобы проверить наличие ошибок при 
выполнении команд. Как только будет уверенность в том, что обновление завершено 
и черновик не содержит ошибок, он может быть применен к проекту и ДТ фактически 
будут обновлены.

```
tdbp.py draft --test draftfile
tdbp.py draft --apply draftfile
```

Если черновиков несколько, то их можно разместить в отдельной директории и 
осуществлять манипуляции над всеми разом.

```
tdbp.py draft --test drafts/*
tdbp.py draft --apply drafts/*
```

Примечание - Так как перебазирование (git rebase) может приводить к потере
актуальности связей, добавленных в рамках рабочей ветви, то связи в формате
черновика имеет смысл хранить до последнего перебазирования, или до момента
слияния рабочей ветви в основную. При этом после каждого перебазирования 
разумно выполнять проверку актуальности связей черновика через режим песочницы.

## ДОПОЛНИТЕЛЬНЫЕ ВОЗМОЖНОСТИ

С подробным описанием всех команд утилиты можно ознакомиться, воспользовавшись
параметром '--help', который может быть передан любой команде и ее подкомандам. 

Просмотр всех связей проекта можно осуществлять в виде таблиц html и csv. Для 
получения соответствующих таблиц необходимо воспользоваться механизмом export.

Чтобы оценить ДТ присутствует возможность собрать покрытие и провести его анализ 
для заданного объединения. Для этого предусмотрена команда stat.

Если артефакты одного уровня, например, ТВУ хранятся в различных репозиториях,
то эти репозитории могут быть объединены через механизм объединений 'unions'.
После объединения репозитории будут приниматься за один, как на этапе работы со 
связями (например, добавление связей между одним репозиторием, а значит и 
всеми репозиториями объединения, запрещено), так и на этапе экспорта (при 
построении связей вверх и вниз). Каждый репозиторий изначально считается
объединением, состоящим из одного репозитория. Также каждому объединению 
назначается уровень, в соответствии с которым при экспорте будут строиться связи.

## ПРОФИЛИРОВАНИЕ

Профилирование используется только в процессе разработки утилиты.

```
apt-get install kcachegrind 
pip install pyprof2calltree

python3 -m cProfile -o script.profile <путь>/sandbox/scm/tdbp/tdbp.py
pyprof2calltree -i script.profile -o script.calltree
kcachegrind script.calltree
```
